'use strict';

var ConsoleTransport = require('./Console');
var FileTransport = require('./File');
var SyslogTransport = require('./Syslog');


module.exports = resolveTransport();


function resolveTransport() {
  var auditToSyslog = process.env.XS_AUDIT_TO_SYSLOG;
  var auditLogFile = process.env.XS_AUDIT_LOG_FILE;

  if (!auditToSyslog && !auditLogFile) {
    return new ConsoleTransport();
  }

  var shouldUseSyslog = /^true$/i.test(auditToSyslog);
  return (shouldUseSyslog) ? createSyslogTransport() : createNonSyslogTransport(auditLogFile);
}

function createSyslogTransport() {
  if (isSyslogLibAvailable()) {
    return new SyslogTransport();
  }
  throw new Error("Audit log library cannot send messages to Syslog - 'sap_syslog' module is missing from currently used Node.js runtime. Use appropriate SAP Node.js distribution.");
}

function createNonSyslogTransport(auditLogFile) {
  if (auditLogFile) {
    return new FileTransport(auditLogFile);
  }
  return new ConsoleTransport();
}

function isSyslogLibAvailable() {
  try {
    require('sap_syslog');
    return true;
  } catch (err) {
    return false;
  }
}
