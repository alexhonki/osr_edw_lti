'use strict';

var xsrfTokenHandler = require('./xsrf-token-handler');

module.exports = function welcomePage(req, res, next) {
  var welcomeFile = req.routerConfig.appConfig.welcomeFile;
  if (welcomeFile && /^\/(\?.*$)?$/.test(req.url)) {
    var tracer = req.loggingContext.getTracer(__filename);
    if (welcomeFile[0] !== '/') {
      welcomeFile = '/' + welcomeFile;
    }
    tracer.info('Incoming request: "%s" will use welcome page "%s"', req.url, welcomeFile);

    if (!xsrfTokenHandler.isTokenFetchRequest(req)) {
      res.writeHead(302, { Location: welcomeFile });
      return res.end();
    }

    req.url = welcomeFile;
  }
  next();
};
