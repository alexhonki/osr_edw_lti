'use strict';

var audit = require('@sap/audit-logging');

module.exports = function isAuthorized(req) {
  if (!req.internalUrl || req.internalUrl.route.authenticationType === 'none') {
    return true;
  }

  var routeScopes = req.internalUrl.route.scope;
  if (!routeScopes) {
    return true;
  }
  if (!Array.isArray(routeScopes)) {
    routeScopes = routeScopes[req.method] || routeScopes.default || [];
  }
  var oauthScopes = req.session && req.session.user && req.session.user.scopes;
  if (!oauthScopes) {
    return false;
  }

  var isAuthorized = routeScopes.some(function(element) {
    return oauthScopes.indexOf(element) > -1;
  });
  if (!isAuthorized) {
    audit.securityMessage('User not authorized')
      .customAttribute('source of route', req.internalUrl.route.source.toString())
      .by(req.session.user.name)
      .customAttribute('required scopes', routeScopes)
      .customAttribute('user scopes', oauthScopes)
      .externalIP(req.headers['x-forwarded-for'] || req.connection.remoteAddress)
      .log(function (err) {
        if (err) {
          throw err;
        }
      });
  }

  return isAuthorized;
};
